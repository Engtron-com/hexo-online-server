<link rel="stylesheet" href="/css/editormd.min.css" />
<script src="/editormd.min.js"></script>
<script src="/js/hintDialog.js"></script>
<script src="/js/dateFormat.js"></script>
<script src="/js/uploadImg.js"></script>
<div style="width: 20%;position: fixed;top:51px;bottom: 0;border-right: 1px solid #333333;height: 94%;">
    <div id="blog-group" style="width: 100%;height: 95%;overflow-x: hidden;max-height: 95%;overflow-y: auto;background: #ffffff;">
        <% posts.forEach(function(post){ %>
            <a href="javascript:void(0)" data-href="#<%= post %>" class="list-group-item" post style="position: relative;"><%= post %></a>
        <% }); %>
    </div>
    <div style="width: 100%;height: 5%;padding-top: 4px;display: flex; justify-content: center;padding: 0;">
        <!-- <input type="text" id="search" style="width: 60%;outline: none;height: 38px;border-radius: 15px; border: 1px solid #f3f3f3;background: #ffffff;color: #4d4d4d;margin-top: 4px;" placeholder="搜索" /> -->
        <a name="new" href="javascript:void(0)" data-href="/shell?action=new_post" style="padding: 12px 20px;flex: 6;" wss type="button" class="btn btn-default">新增</a>
        <a name="delete" href="javascript:void(0)" data-href="/shell?action=delete_post" wss type="button" style="padding: 12px 20px;flex: 6;" class="btn btn-default" post-id="#">删除</a>
    </div>
</div>
<div class="btn-group" style="position: fixed;margin-left: 20%;width: 80%;top: 52px;height: 94%;"> 
    <div class="el-form-item__content" style="width:100%;height:5%;background-color: #dddddd;padding-top: 4px;margin-left: 10px;">
        <div class="input__title flex1 el-input" style="width: 86%;height: 38px; float: left;">
            <input type="text" style=" width: 100%;outline: none; height: 38px;border: 1px solid #f3f3f3;padding:0 10px; background: #ffffff;color: #4d4d4d;" autocomplete="off" id="txtTitle" post-id="#" maxlength="100" placeholder="2020-11-18" class="el-input__inner"/>
            <!-- <span class="el-input__suffix"><span class="el-input__suffix-inner">
            <span class="el-input__count"><span class="el-input__count-inner">10/100</span></span></span>
            </span> -->
        </div>
        <div class="article-bar__user-box flex flex--row flex--align-center" style="width: 14%;display: flex;flex-direction: row;justify-content: center;float: left;">
            <button type="button" style="padding: 6px 20px;
            font-size: 16px;
            color: #e33e33;
            border: 1px solid #e33e33; margin: 2px 10px;" class="el-button btn btn-save el-button--text">保存</button>
            <button type="button" style="padding: 6px 20px;
            font-size: 16px;
            color: #ffffff;
            border: 1px solid #e33e33;background:#e33e33 ; margin: 2px 10px;" class="el-button btn btn-publish el-button--primary">发布</button>
        </div>
    </div>
    <!-- <a name="rename" href="/shell?action=rename_post" wss type="button" class="btn btn-default" post-id="#">重命名</a> -->
    <div id="editor" style="width: 100%;height:95%;">
    </div>
</div>
<script>
    $(".list-group-item").bind("click", function (e) {
        $(".list-group-item").removeClass("active");
        $(this).addClass("active");
        let titleEl = document.getElementById('txtTitle');
        let title = e.target.innerText || '#';
        $(titleEl).attr('post-id', title);
        $(txtTitle).attr('placeholder', title);
    });
    $(".list-group-item")[0] &&  $(".list-group-item")[0].click();
    $("a[post]").bind("click", getPost);

    $("a[post]")[0] && $("a[post]")[0].click();
    $("a[wss]").bind("click", function (e) {
        let href = $(this).attr("data-href");
        switch ($(this).attr("name")) {
            case "new":
                ev.preventDefault();
                let name = dateFormat('YYYY-MM-DD HH:mm:ss');
                $.get(href, {
                    post: name
                }, function (data, status) {
                    if (status === "success") {
                        addItem(name);
                    }
                });
                break;
            case "delete":
                let that = this;
                $.MsgBox.Confirm('温馨提示！', '确认删除当前文章？', function() {
                    $.get(href, {
                        post: $(that).attr("post-id")
                    });
                })
                break;
            default:
                swal("未知操作", "error");
                break;
        }
        return false;
    });
    $(".btn-save").click(function () {
        let currentEl = $(".list-group-item.active");
        let titleEl = $('#txtTitle');
        let old_name = $(titleEl).attr('post-id');
        let val = $(titleEl).val();
        if (val && old_name !== val) {
            $.ajax({
                url: '/shell?action=rename_post',
                data: {
                    old_name: old_name,
                    new_name: val
                },
                type: 'get',
                success : function(res) {
                    $(currentEl).text(val);
                    $.ajax({
                        url: '/shell?action=save_post',
                        data: {
                            post: val,
                            data: $(".editormd-markdown-textarea").val()
                        },
                        type: 'post',
                        dataType: 'json',
                        success: function (res) {
                            swal("保存成功", "success");
                        }
                    })
                }
            })
        } else {
            $.ajax({
                url: '/shell?action=save_post',
                data: {
                    post: $(currentEl).text(),
                    data: $(".editormd-markdown-textarea").val()
                },
                type: 'post',
                dataType: 'json',
                success: function (res) {
                    swal("保存成功", "success");
                }
            })
        }
    });
    $(".btn-publish").click(function () {
        $.get("/shell?action=clean", function (data, status, xhr) {
            if (status === "success") {  
                $.get("/shell?action=generate");
            }
        })
    });

    $("#search").bind('input', throttle(function(e) {
        let val = $(this).val();
        let aList = document.querySelectorAll('.list-group-item');
        if (!val) {
            aList.forEach( aEl => {
                aEl.style.display = 'block';
            })
        } else {
            aList.forEach( aEl => {
                let text = aEl.innerText;
                if (!text || !text.indexOf(val) === -1) {
                    aEl.style.display = 'none';
                }
            })
        }
    }, 1500));

    function getPost() {
        let postId = $(this).attr("data-href");
        $.get('/getPost', {
            post: postId
        }, function (data, status, xhr) {
            if (status === "success" && data.success) {
                let editor = editormd("editor", {
                    width: "100%",
                    height: "95%",
                    markdown: data.data, // dynamic set Markdown text
                    path: "/lib/" // Autoload modules mode, codemirror, marked... dependents libs path
                });
                $('a[post-id]').attr("post-id", postId);
                let autoSaveTime = <%= autoSave %> ;
                if (autoSaveTime) {
                    if (window.autoSave) clearInterval(window.autoSave);
                    window.autoSave = setInterval(() => {
                        $.post("/shell?action=save_post", {
                            post: $(".list-group-item.active").text(),
                            data: $(".editormd-markdown-textarea").val()
                        });
                    }, autoSaveTime);
                }
                initPasteDragImg(editor);
            } else {
                swal("\n获取文章失败", "error");
            }
        });
        $.get('/shell?action=get_postname',{
            post: postId
        });
    }

    function addItem(name) {
        let a = document.createElement('a');
        a.href = "javascript:void(0)";
        a.className = "list-group-item";
        a.setAttribute('data-href', '#' + name);
        a.setAttribute('post', '');
        a.style = "position: relative";
        a.innerText = name;
        $('#blog-group').append(a);
        $(a).bind('click', getPost);
    }

    function throttle(fun, delay) {
        let time = null;
        return function() {
            if (time) {
            return;
            }
            time = setTimeout(()=> {
                fun.call(null, ...arguments);
                time = null;
            }, delay)
        }
    }
</script>